{
  "branch": "billing-overhaul",
  "tests": [
    {
      "id": "change-plan-via-billing-modal",
      "category": "Billing",
      "description": "Plan changes route correctly: Free users without payment go through Stripe Checkout; returning customers with payment get instant switch; no double-billing on upcoming invoice",
      "steps": [
        "As a Free user with no payment method, open Settings > Billing > View Plans and select a paid plan (e.g., Team)",
        "Verify you are redirected to Stripe Checkout (not an instant switch)",
        "Complete checkout and verify the plan is active with a clean upcoming invoice (single charge, no proration artifacts)",
        "Now switch to a different paid plan (e.g., Team to Starter)",
        "Verify the switch is instant (no Stripe Checkout redirect) since you now have a payment method",
        "Check the Stripe dashboard — verify the upcoming invoice shows only the new plan price, not double-billing",
        "Verify there is only ONE active subscription in Stripe at all times"
      ],
      "setup": "Org should be on Free plan with no payment method and no prior trial (trial_end_date is null). Verify in Stripe dashboard that the org's customer has no active subscriptions before testing.",
      "expected": "Free user without payment → Stripe Checkout. Returning customer with payment → instant switch. Upcoming invoice shows single plan charge. Only one subscription exists in Stripe.",
      "status": null,
      "feedback": null
    },
    {
      "id": "downgrade-to-free",
      "category": "Billing",
      "description": "Downgrading to Free schedules cancellation at end of billing cycle — no proration, no rounding artifacts",
      "steps": [
        "From a paid plan (e.g., Team), open Settings > Billing > View Plans and select Free",
        "Verify a success message mentioning end-of-cycle downgrade appears",
        "Open Settings > Billing — verify status shows 'Downgrading' in amber",
        "Verify the amber banner appears: 'Your plan will change to Free at the end of your current billing cycle...'",
        "Verify you still have full access to paid features (DaemonPoll, scheduled discovery, etc.)",
        "Check Stripe dashboard — verify the subscription shows 'Cancels at period end' with NO proration line items or $0.01 charges",
        "Optionally: upgrade to a paid plan again — verify the pending cancellation is cleared and features remain"
      ],
      "setup": "Org should be on a paid plan with an active Stripe subscription.",
      "expected": "Downgrade schedules end-of-cycle cancellation. Status shows 'Downgrading'. User keeps features until period ends. No proration artifacts in Stripe. Upgrading again clears the pending cancellation.",
      "status": null,
      "feedback": null
    },
    {
      "id": "payment-method-sync",
      "category": "Billing",
      "description": "Payment method status syncs from Stripe on subscription updates",
      "steps": [
        "Open Stripe dashboard and remove the default payment method from the subscription",
        "Trigger a subscription update (e.g., switch plans or wait for webhook)",
        "Open Settings > Billing — verify the 'Add Payment Method' card reappears (has_payment_method = false)"
      ],
      "setup": "Org should be on a paid plan with has_payment_method = true and a payment method in Stripe.",
      "expected": "Removing payment method in Stripe syncs to frontend state via webhook",
      "status": null,
      "feedback": null
    }
  ]
}
