{
  "branch": "billing-overhaul",
  "tests": [
    {
      "id": "change-plan-via-billing-modal",
      "category": "Billing",
      "description": "Changing plan via billing modal updates existing Stripe subscription (no duplicate subscriptions)",
      "steps": [
        "Open Settings > Billing > View Plans",
        "Select a different plan (e.g., switch from Free to Starter, or Starter to Team)",
        "Verify the modal closes and a success toast appears (no Stripe checkout redirect for existing subscribers)",
        "Open Settings > Billing — verify the plan updated",
        "Open the Stripe dashboard — verify there is only ONE subscription (updated, not two)",
        "Switch to a different plan again — verify the same subscription is updated, not a new one created"
      ],
      "setup": "Org should be on a paid plan with an active Stripe subscription. Verify in Stripe dashboard that only one subscription exists before testing.",
      "expected": "Plan changes update the existing subscription. Only one subscription in Stripe at any time. Success toast shown, no checkout redirect for existing subscribers.",
      "status": null,
      "feedback": null
    },
    {
      "id": "downgrade-to-free",
      "category": "Billing",
      "description": "Downgrading to Free via billing modal or Stripe portal results in single Free subscription",
      "steps": [
        "Open Settings > Billing > View Plans",
        "Select the Free plan",
        "Verify the modal closes and a success toast appears",
        "Open Settings > Billing — verify plan is now Free with active status",
        "Open Stripe dashboard — verify there is only ONE subscription (Free)",
        "Verify DaemonPoll daemons are set to standby and scheduled discoveries converted to ad-hoc"
      ],
      "setup": "Org should be on a paid plan with an active Stripe subscription, at least one DaemonPoll daemon, and one scheduled discovery.",
      "expected": "Free plan set via subscription update (not new subscription). Single subscription in Stripe. Restrictions enforced.",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-poll-free-plan-interaction",
      "category": "Daemon",
      "description": "Daemon standby cleared on upgrade, immutable via API",
      "steps": [
        "Verify the daemon is in standby (from previous downgrade to Free)",
        "Open Settings > Billing > View Plans and upgrade to a paid plan (e.g., Starter)",
        "Verify the DaemonPoll daemon standby is automatically cleared — daemon should be functional",
        "Try editing the daemon via the UI — verify standby field is not shown as editable"
      ],
      "setup": "Org should be on Free plan with a DaemonPoll daemon in standby state. Use the API to verify: PUT /api/daemons/<id> with standby:false should NOT change the standby value (it's preserved from existing).",
      "expected": "Upgrading to a paid plan clears daemon standby automatically. Standby field is immutable via API updates.",
      "status": null,
      "feedback": null
    },
    {
      "id": "plan-change-email",
      "category": "Emails",
      "description": "Email notification sent on any plan change (upgrade, downgrade, tier switch)",
      "steps": [
        "Change plan via the billing modal (e.g., Free to Starter or Starter to Free)",
        "Check email inbox for plan change notification",
        "Verify the email mentions old plan, new plan, and relevant details"
      ],
      "setup": "Org should be on any plan with an active subscription.",
      "expected": "PlanChanged email sent for any plan change regardless of source (UI, Stripe portal, etc.)",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-ending-email",
      "category": "Emails",
      "description": "Trial ending soon email is sent when trial is about to expire",
      "steps": [
        "Check email inbox for trial-ending notification",
        "Verify the email contains: plan name, trial status, and whether payment method is on file"
      ],
      "setup": "Set org to trialing with trial ending in 3 days: UPDATE organizations SET plan = '{\"type\":\"Starter\",\"base_cents\":1500,\"rate\":\"Month\",\"trial_days\":7,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":1,\"included_hosts\":100}', plan_status = 'trialing', trial_end_date = NOW() + INTERVAL '3 days', has_payment_method = false WHERE id = '<org_id>'. Trigger the trial_will_end webhook from Stripe (may need to use Stripe CLI: stripe trigger customer.subscription.trial_will_end).",
      "expected": "TrialWillEnd email received with plan details and payment method status",
      "status": null,
      "feedback": null
    },
    {
      "id": "payment-method-sync",
      "category": "Billing",
      "description": "Payment method status syncs from Stripe on subscription updates",
      "steps": [
        "Open Stripe dashboard and remove the default payment method from the subscription",
        "Trigger a subscription update (e.g., switch plans or wait for webhook)",
        "Open Settings > Billing — verify the 'Add Payment Method' card reappears (has_payment_method = false)"
      ],
      "setup": "Org should be on a paid plan with has_payment_method = true and a payment method in Stripe.",
      "expected": "Removing payment method in Stripe syncs to frontend state via webhook",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-modal-after-checkout",
      "category": "Onboarding",
      "description": "After first Stripe checkout, app opens daemon creation modal",
      "steps": [
        "Register a new account and complete onboarding",
        "Select a plan in the billing modal — complete Stripe checkout",
        "After redirect back to the app, verify the daemons tab is active",
        "Verify the create daemon modal opens automatically"
      ],
      "setup": "Requires a fresh account with no prior billing setup. Complete registration and onboarding steps up to the billing modal.",
      "expected": "After checkout redirect, session_id is detected, showDaemonSetup flag set, daemons tab opens with create daemon modal",
      "status": null,
      "feedback": null
    }
  ]
}
