{
<<<<<<< HEAD
<<<<<<< HEAD
  "branch": "billing-overhaul",
  "tests": [
    {
      "id": "billing-modal-opens-no-plan",
      "category": "Billing Modal",
      "description": "New user sees non-dismissible billing modal after onboarding",
      "steps": [
        "After onboarding completes, verify the billing plan modal opens automatically",
        "Verify the modal has title 'Choose a Plan' and is full-screen",
        "Verify clicking outside does NOT close the modal",
        "Verify no close (X) button is shown"
      ],
      "expected": "Full-screen billing modal opens with plan options, cannot be dismissed",
      "flow": "setup",
      "sequence": 1,
=======
  "branch": "brevo-integration",
  "tests": [
    {
      "id": "brevo-server-starts-without-api-key",
      "category": "Configuration",
      "description": "Server starts normally when SCANOPY_BREVO_API_KEY is not set",
      "steps": [
        "Ensure SCANOPY_BREVO_API_KEY is NOT set in your environment",
        "Start the server with make dev-up",
        "Check server logs for startup messages"
      ],
      "expected": "Server starts successfully. No errors related to Brevo.",
=======
  "branch": "fix-ghost-printing",
  "tests": [
    {
      "id": "default-scan-no-ghost-print",
      "category": "Ghost Print Prevention",
      "description": "Default network discovery does not send HTTP requests to port 9100 (JetDirect range)",
      "steps": [
        "Create a new Network discovery with default settings",
        "Verify the 'Probe raw socket ports (9100-9107)' checkbox is unchecked by default",
        "Run the discovery against a subnet containing a printer on port 9100",
        "Check the printer — no ghost/garbage pages should print"
      ],
      "expected": "Discovery completes without triggering any print jobs on JetDirect printers. Port 9100 is detected as open but no HTTP probe is sent.",
>>>>>>> fix-ghost-printing
      "status": null,
      "feedback": null
    },
    {
<<<<<<< HEAD
<<<<<<< HEAD
      "id": "brevo-server-starts-with-api-key",
      "category": "Configuration",
      "description": "Server starts and triggers backfill when SCANOPY_BREVO_API_KEY is set",
      "steps": [
        "Set SCANOPY_BREVO_API_KEY to a valid Brevo API key in your environment",
        "Start the server with make dev-up",
        "Check server logs for Brevo backfill messages"
      ],
      "expected": "Server starts successfully. Logs show backfill progress messages like 'Backfilling org {name} (x/total)'. Server does not block on backfill (responds to requests during sync).",
=======
      "id": "opt-in-node-exporter-detection",
      "category": "Ghost Print Prevention",
      "description": "Prometheus Node Exporter is detected when raw socket port probing is enabled",
      "steps": [
        "Create a new Network discovery",
        "Check the 'Probe raw socket ports (9100-9107)' checkbox",
        "Run the discovery against a host running Prometheus Node Exporter on port 9100",
        "Check the discovered host's services"
      ],
      "expected": "Prometheus Node Exporter is detected and listed as a service on the host.",
>>>>>>> fix-ghost-printing
      "status": null,
      "feedback": null
    },
    {
<<<<<<< HEAD
      "id": "brevo-backfill-creates-contacts-and-companies",
      "category": "Startup Backfill",
      "description": "Backfill creates Brevo contacts and companies for all orgs",
      "steps": [
        "Set SCANOPY_BREVO_API_KEY and start the server",
        "Wait for backfill to complete (check logs)",
        "Log into Brevo dashboard, go to Contacts",
        "Check Companies in Brevo CRM"
      ],
      "expected": "Each organization's owner appears as a contact in Brevo with correct attributes (email, name, scanopy_user_id). Each org has a corresponding company with correct attributes (name, scanopy_org_id, plan info, entity counts). Contact is linked to company.",
=======
      "id": "toggle-help-text-shows-affected-services",
      "category": "UI Toggle",
      "description": "The raw socket ports checkbox dynamically lists affected services in its help text",
      "steps": [
        "Open the create/edit discovery modal",
        "Select 'Network' as the discovery type",
        "Locate the 'Probe raw socket ports (9100-9107)' checkbox",
        "Read the help text below the checkbox"
      ],
      "expected": "Help text says 'May cause ghost printing on JetDirect printers. Required to detect: Prometheus Node Exporter' (or similar, listing all services with raw socket endpoints).",
>>>>>>> fix-ghost-printing
      "status": null,
      "feedback": null
    },
    {
<<<<<<< HEAD
      "id": "brevo-backfill-idempotent",
      "category": "Startup Backfill",
      "description": "Restarting server does not re-sync already-synced orgs",
      "steps": [
        "After initial backfill completes, restart the server",
        "Check server logs for backfill messages"
      ],
      "expected": "No backfill messages appear (or log says 0 orgs to backfill). Already-synced orgs are skipped because brevo_company_id is not NULL.",
=======
      "id": "toggle-only-visible-for-network",
      "category": "UI Toggle",
      "description": "The raw socket ports checkbox only appears for Network discovery type",
      "steps": [
        "Open the create discovery modal",
        "Select 'Network' as the discovery type — verify checkbox is visible",
        "Switch to 'Docker' discovery type — verify checkbox disappears",
        "Switch to 'Self Report' discovery type — verify checkbox is not shown",
        "Switch back to 'Network' — verify checkbox reappears"
      ],
      "expected": "The 'Probe raw socket ports' checkbox is only visible when Network discovery type is selected.",
>>>>>>> fix-ghost-printing
      "status": null,
      "feedback": null
    },
    {
<<<<<<< HEAD
      "id": "brevo-syncs-all-orgs-no-filtering",
      "category": "Sync Behavior",
      "description": "All organizations are synced regardless of plan type or email domain",
      "steps": [
        "Register a new user with a free email domain (e.g., user@gmail.com)",
        "Ensure the org has a free/trial plan",
        "Check Brevo dashboard for the new contact and company"
      ],
      "expected": "Contact and company are created in Brevo. No filtering by commercial plan or work email domain.",
      "flow": "setup",
      "sequence": 31,
>>>>>>> brevo-integration
=======
      "id": "toggle-persists-on-save",
      "category": "UI Toggle",
      "description": "The probe_raw_socket_ports setting persists after saving and reloading the discovery",
      "steps": [
        "Create a new Network discovery with 'Probe raw socket ports' checked",
        "Save the discovery",
        "Reopen the discovery for editing",
        "Check the state of the checkbox"
      ],
      "expected": "The checkbox is still checked after saving and reopening.",
>>>>>>> fix-ghost-printing
      "status": null,
      "feedback": null
    },
    {
<<<<<<< HEAD
<<<<<<< HEAD
      "id": "referral-source-other-text",
      "category": "Onboarding",
      "description": "Selecting 'Other' referral source shows free text input",
=======
      "id": "billing-modal-plan-toggles",
      "category": "Billing Modal",
<<<<<<< HEAD
      "description": "Monthly/yearly and personal/commercial toggles work in billing modal",
>>>>>>> billing-overhaul
=======
      "description": "Monthly/yearly and personal/commercial toggles work",
>>>>>>> billing-overhaul
      "steps": [
        "Click the Monthly/Yearly toggle",
        "Verify prices update to reflect the selected billing period",
        "Click the Personal/Commercial toggle",
        "Verify plan cards filter to show the correct category"
      ],
      "expected": "Toggles are responsive and filter/update plan display correctly",
      "flow": "setup",
      "sequence": 2,
=======
      "id": "brevo-org-created-event",
      "category": "Event Handling",
      "description": "New org creation triggers Brevo contact + company creation and event tracking",
      "steps": [
        "After registering the new user (from previous test), check Brevo Contacts for the new user",
        "Check Brevo Companies for the new org",
        "Check database: SELECT brevo_company_id FROM organizations WHERE name = '<org name>';"
      ],
      "expected": "Contact created with correct attributes. Company created and linked to contact. brevo_company_id stored on the org (non-NULL in DB).",
      "flow": "setup",
      "sequence": 32,
>>>>>>> brevo-integration
=======
      "id": "toggle-default-false-on-save",
      "category": "UI Toggle",
      "description": "The probe_raw_socket_ports defaults to false and persists as unchecked",
      "steps": [
        "Create a new Network discovery without touching the raw socket ports checkbox",
        "Save the discovery",
        "Reopen the discovery for editing",
        "Check the state of the checkbox"
      ],
      "expected": "The checkbox remains unchecked (default false).",
>>>>>>> fix-ghost-printing
      "status": null,
      "feedback": null
    },
    {
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
      "id": "onboarding-three-steps",
      "category": "Onboarding",
      "description": "Onboarding flow has exactly 3 steps (no daemon/verification steps)",
=======
      "id": "free-plan-checkout",
      "category": "Billing Modal",
<<<<<<< HEAD
      "description": "Selecting Free plan redirects to Stripe checkout ($0, no card required)",
>>>>>>> billing-overhaul
=======
      "description": "Selecting Free plan completes $0 Stripe checkout without requiring a card",
>>>>>>> billing-overhaul
      "steps": [
        "Select the Free plan",
        "Verify redirect to Stripe checkout",
        "Complete the $0 checkout — no credit card should be required",
        "Verify redirect back to the app",
        "Verify the billing modal is gone and the app is accessible"
      ],
      "expected": "Stripe checkout completes without payment method, user returns to app with Free plan active, modal dismissed",
      "flow": "setup",
      "sequence": 3,
=======
      "id": "brevo-login-updates-last-login",
      "category": "Event Handling",
      "description": "Login event updates contact's last login date in Brevo",
      "steps": [
        "Ensure a user is synced to Brevo",
        "Log in as that user",
        "Check the contact in Brevo dashboard"
      ],
      "expected": "Contact's SCANOPY_LAST_LOGIN_DATE attribute is updated to the current login timestamp.",
>>>>>>> brevo-integration
=======
      "id": "jetdirect-service-detected",
      "category": "Service Detection",
      "description": "JetDirect printers are identified as a JetDirect service via port-only detection",
      "steps": [
        "Run a default Network discovery (raw socket probing OFF) against a subnet with a JetDirect printer on port 9100",
        "Check the discovered host's services"
      ],
      "expected": "The printer host shows a 'JetDirect' service detected via port 9100, without any HTTP probe being sent.",
>>>>>>> fix-ghost-printing
      "status": null,
      "feedback": null
    },
    {
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
      "id": "onboarding-single-network",
      "category": "Onboarding",
      "description": "Onboarding creates exactly one network, no 'add another' option",
=======
      "id": "billing-modal-dismissed-after-plan",
      "category": "Billing Modal",
      "description": "Billing modal disappears after plan is selected and Stripe checkout completes",
>>>>>>> billing-overhaul
      "steps": [
        "After completing Stripe checkout (from previous test), return to app",
        "Verify the billing plan modal is no longer shown",
        "Verify the main app is accessible"
      ],
      "expected": "Modal gone, app fully accessible with selected plan",
      "flow": "setup",
      "sequence": 4,
=======
      "id": "brevo-entity-metrics-sync",
      "category": "Event Handling",
      "description": "Creating/deleting networks, hosts, or users updates company metrics in Brevo",
      "steps": [
        "Create a new network in an org that is synced to Brevo",
        "Check the company in Brevo dashboard for updated network_count",
        "Create a host, check host_count",
        "Delete the host, check host_count again"
      ],
      "expected": "Company attributes (scanopy_network_count, scanopy_host_count, scanopy_user_count) reflect current DB counts after each change.",
>>>>>>> brevo-integration
=======
      "id": "non-raw-socket-services-unaffected",
      "category": "Regression",
      "description": "Services on non-raw-socket ports are still detected normally regardless of toggle state",
      "steps": [
        "Run a Network discovery with 'Probe raw socket ports' unchecked",
        "Verify that HTTP-based services on standard ports (e.g., port 80, 443, 8080) are still detected",
        "Check that services like Nginx, Apache, Grafana, etc. appear on discovered hosts"
      ],
      "expected": "All non-raw-socket-port services are detected normally. The filter only affects ports 9100-9107.",
>>>>>>> fix-ghost-printing
      "status": null,
      "feedback": null
    },
    {
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
      "id": "referral-source-tracked-posthog",
      "category": "Onboarding",
      "description": "Referral source is included in PostHog analytics event",
=======
      "id": "trial-offers-first-time",
      "category": "Billing Modal",
      "description": "Trial offers shown to orgs that have never trialed a paid plan",
>>>>>>> billing-overhaul
=======
      "id": "trial-offers-first-time",
      "category": "Billing Modal",
      "description": "Trial badges shown for orgs that have never trialed a paid plan",
>>>>>>> billing-overhaul
      "steps": [
        "Open Settings > Billing tab",
        "Click 'View Plans'",
        "Verify paid plans show trial day badges (e.g., '7-day free trial')"
      ],
<<<<<<< HEAD
<<<<<<< HEAD
      "expected": "Event includes referral_source property with the selected value. If 'other', includes referral_source_other.",
      "flow": "setup",
      "sequence": 5,
=======
      "id": "brevo-enterprise-inquiry-happy-path",
      "category": "Enterprise Inquiry",
      "description": "Submitting enterprise inquiry sends data to Brevo instead of HubSpot",
      "steps": [
        "Log in as a user with a synced org",
        "Navigate to billing and open the enterprise inquiry modal",
        "Fill in all fields (company name, size, use case, message)",
        "Submit the form",
        "Check Brevo company attributes and enterprise_inquiry event"
      ],
      "expected": "Form submits successfully. Brevo company updated with inquiry properties (inquiry_date, inquiry_urgency, inquiry_network_count, inquiry_plan_type). enterprise_inquiry event tracked with full details (company, team_size, message, urgency, plan_type).",
>>>>>>> brevo-integration
=======
      "id": "docker-discovery-probes-raw-socket-ports",
      "category": "Regression",
      "description": "Docker discovery always probes raw socket ports (containers are never printers)",
      "steps": [
        "Create a Docker discovery",
        "Run it against a Docker host that has a container exposing port 9100 with Prometheus Node Exporter",
        "Check discovered services"
      ],
      "expected": "Docker discovery detects Prometheus Node Exporter on port 9100. No raw socket toggle is shown in Docker discovery settings since it always probes.",
>>>>>>> fix-ghost-printing
=======
      "expected": "Trial offers are visible on paid plans for orgs without trial_end_date",
>>>>>>> billing-overhaul
=======
      "setup": "Org should be on the Free plan with no trial_end_date set (the default state after the setup flow).",
      "expected": "Trial offers visible on paid plans",
>>>>>>> billing-overhaul
      "status": null,
      "feedback": null
    },
    {
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
      "id": "new-user-starts-on-free",
      "category": "Onboarding",
      "description": "New users start on Free plan after completing onboarding",
=======
      "id": "trial-offers-returning",
      "category": "Billing Modal",
<<<<<<< HEAD
      "description": "Trial offers hidden for orgs that have previously trialed",
>>>>>>> billing-overhaul
=======
      "description": "Trial badges hidden for orgs that have previously trialed",
>>>>>>> billing-overhaul
      "steps": [
        "Open Settings > Billing tab",
        "Click 'View Plans'",
        "Verify paid plans do NOT show trial day badges"
      ],
<<<<<<< HEAD
<<<<<<< HEAD
      "expected": "Newly registered user is on Free plan with active status",
      "flow": "setup",
      "sequence": 6,
=======
      "id": "brevo-no-hubspot-tracking-script",
      "category": "Frontend Cleanup",
      "description": "HubSpot tracking script is no longer loaded in the frontend",
      "steps": [
        "Load the app in a browser",
        "Open dev tools and check Network tab for any requests to hubspot.com or hs-scripts.com",
        "Check Elements/Sources for any HubSpot script tags"
      ],
      "expected": "No requests to HubSpot domains. No HubSpot script tags in the DOM. No hubspotutk cookie set.",
>>>>>>> brevo-integration
=======
      "id": "existing-discovery-backward-compat",
      "category": "Regression",
      "description": "Existing Network discoveries without probe_raw_socket_ports field still work (serde default)",
      "steps": [
        "If there are pre-existing Network discoveries created before this change, open them for editing",
        "Verify they load without errors",
        "Check that the raw socket ports checkbox defaults to unchecked"
      ],
      "expected": "Pre-existing discoveries deserialize correctly with probe_raw_socket_ports defaulting to false. No errors or data loss.",
>>>>>>> fix-ghost-printing
=======
=======
      "setup": "Set trial_end_date on the org to a past date: UPDATE organizations SET trial_end_date = NOW() - INTERVAL '1 day' WHERE id = '<org_id>'. Refresh the browser before testing.",
>>>>>>> billing-overhaul
      "expected": "No trial offers shown to returning customers",
>>>>>>> billing-overhaul
      "status": null,
      "feedback": null
    },
    {
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
      "id": "onboarding-lands-on-daemons",
      "category": "Onboarding",
      "description": "After onboarding, user lands on daemons tab with create modal auto-opened",
=======
      "id": "settings-billing-view-plans",
      "category": "Settings",
      "description": "View Plans button in Settings > Billing opens dismissible billing modal",
>>>>>>> billing-overhaul
      "steps": [
        "Open Settings modal",
        "Navigate to the Billing tab",
        "Click 'View Plans' button",
        "Verify billing plan modal opens",
        "Verify modal IS dismissible (close button, click outside works)"
      ],
      "expected": "Modal opens in dismissible mode from settings",
      "status": null,
      "feedback": null
    },
    {
      "id": "settings-billing-notification-dot",
      "category": "Settings",
      "description": "Billing tab shows notification dot when plan needs attention",
      "steps": [
        "As an org with no plan selected (new org before choosing), open Settings",
        "Verify the Billing tab has a notification dot",
        "Also verify notification dot for: trialing without payment method, past_due, canceled"
      ],
      "expected": "Notification dot visible on Billing tab when action is needed",
      "status": null,
      "feedback": null
    },
    {
=======
>>>>>>> billing-overhaul
      "id": "settings-billing-free-plan-cta",
      "category": "Settings",
      "description": "Free plan users see upgrade CTA and no subscription management in Billing tab",
      "steps": [
        "Open Settings > Billing tab",
        "Verify an 'Upgrade your plan' card with 'View Plans' button is shown",
        "Verify 'Manage Subscription' button is NOT present"
      ],
      "setup": "Org should be on the Free plan (default state after setup flow).",
      "expected": "Prominent upgrade CTA shown, no subscription management for Free plan",
      "status": null,
      "feedback": null
    },
    {
      "id": "settings-billing-notification-dot",
      "category": "Settings",
      "description": "Billing tab shows notification dot when trialing without payment method",
      "steps": [
        "Open the Settings modal",
        "Verify the Billing tab label has a notification dot"
      ],
      "setup": "Set org to trialing status without a payment method: UPDATE organizations SET plan_status = 'trialing', has_payment_method = false WHERE id = '<org_id>'. Refresh the browser before testing.",
      "expected": "Notification dot visible on Billing tab",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-mode-richselect-upgrade",
      "category": "Daemon Creation",
      "description": "Daemon mode dropdown shows Upgrade tag on DaemonPoll for Free plan",
      "steps": [
        "Navigate to the Daemons page and open the daemon creation modal",
        "Open the Mode dropdown — it should be a rich dropdown, not a native select",
        "Verify ServerPoll is selectable",
        "Verify DaemonPoll shows a yellow 'Upgrade' tag with an arrow icon",
        "Verify DaemonPoll is not selectable (disabled/grayed out)"
      ],
      "setup": "Org should be on the Free plan. Ensure at least one network exists (POST /api/networks with a name).",
      "expected": "RichSelect dropdown with yellow Upgrade tag on DaemonPoll, option disabled",
      "status": null,
      "feedback": null
    },
    {
      "id": "discovery-run-type-richselect-upgrade",
      "category": "Discovery",
      "description": "Discovery run type dropdown shows Upgrade tag on Scheduled for Free plan",
      "steps": [
        "Navigate to the Discoveries page and open the discovery creation modal",
        "Open the Run Type dropdown — it should be a rich dropdown, not a native select",
        "Verify Ad Hoc is selectable",
        "Verify Scheduled shows a yellow 'Upgrade' tag with an arrow icon",
        "Verify Scheduled is not selectable (disabled)"
      ],
      "setup": "Org should be on the Free plan. Ensure at least one daemon exists (create via the Daemons page or API).",
      "expected": "RichSelect dropdown with yellow Upgrade tag on Scheduled, option disabled",
      "status": null,
      "feedback": null
    },
    {
      "id": "paid-plan-no-upgrade-tags",
      "category": "Paid Plan",
      "description": "Paid plan users see no upgrade tags in daemon/discovery dropdowns",
      "steps": [
        "Open daemon creation modal, open the Mode dropdown",
        "Verify DaemonPoll has no Upgrade tag and is selectable",
        "Open discovery creation modal, open the Run Type dropdown",
        "Verify Scheduled has no Upgrade tag and is selectable"
      ],
      "setup": "Org should be on a paid plan (e.g., Starter). Set via Stripe checkout or DB: UPDATE organizations SET plan = 'Starter', plan_status = 'active' WHERE id = '<org_id>'. Ensure at least one network and one daemon exist.",
      "expected": "No upgrade tags, all options selectable for paid plans",
      "status": null,
      "feedback": null
    },
    {
      "id": "stripe-cancel-returns-home",
      "category": "Billing",
      "description": "Canceling Stripe checkout returns to app root, not /billing",
      "steps": [
        "Open Settings > Billing > View Plans",
        "Select any paid plan to start checkout",
        "On the Stripe checkout page, click Back or cancel",
        "Verify the return URL is the app root (/), not /billing"
      ],
<<<<<<< HEAD
<<<<<<< HEAD
      "expected": "API returns 403 with error code 'billing_feature_not_available' mentioning 'Scheduled Discovery'",
      "status": null,
      "feedback": null
    },
    {
      "id": "scheduled-discovery-update-blocked-free",
      "category": "Backend Enforcement",
      "description": "Updating a discovery to Scheduled type blocked on Free plan",
      "steps": [
        "On Free plan, have an existing AdHoc discovery",
        "Attempt to update it to RunType::Scheduled via API: PUT /api/discoveries/:id",
        "Check response"
      ],
      "expected": "API returns 403 with error code 'billing_feature_not_available' mentioning 'Scheduled Discovery'",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-poll-registration-blocked-free",
      "category": "Backend Enforcement",
      "description": "DaemonPoll daemon registration blocked on Free plan",
      "steps": [
        "On Free plan, attempt to register a daemon with DaemonPoll mode",
        "Check the registration response"
      ],
      "expected": "API returns 403 with error code 'billing_feature_not_available' mentioning 'DaemonPoll'",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-standby-signal",
      "category": "Backend Enforcement",
      "description": "DaemonPoll daemon receives standby error and blocks indefinitely",
      "steps": [
        "Set up org with active DaemonPoll daemon on paid plan",
        "Downgrade org to Free plan",
        "Observe daemon's request-work call",
        "Check daemon logs"
      ],
      "expected": "Daemon receives DaemonStandby error code. Daemon logs 'Plan does not support DaemonPoll mode. Daemon is on standby.' and blocks (does not exit or retry).",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-standby-backward-compat",
      "category": "Backend Enforcement",
      "description": "Standby signal is backward-compatible (no response format change)",
      "steps": [
        "Verify request-work endpoint still returns (Option<DiscoveryUpdatePayload>, bool) tuple on success",
        "Verify standby is signaled via ApiError (not tuple field change)",
        "Old daemons that don't handle DaemonStandby specifically should still stop gracefully"
      ],
      "expected": "Response format unchanged. Old daemons exit via generic error handler. New daemons block on standby.",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-without-credit-card",
      "category": "Trial Flow",
      "description": "Trial starts without requiring credit card",
      "steps": [
        "Log in as owner on Free plan",
        "Open plan selection modal",
        "Select a paid plan that has trial_days > 0 (e.g., Starter)",
        "Click to start trial",
        "Verify no credit card form appears",
        "Check org plan status"
      ],
      "expected": "Trial starts immediately without credit card. Org plan_status is 'trialing'. trial_end_date is set.",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-end-date-visible",
      "category": "Trial Flow",
      "description": "Trial countdown visible in billing settings",
      "steps": [
        "Log in as owner on a trialing plan",
        "Navigate to Settings > Billing tab",
        "Look for trial countdown"
      ],
      "expected": "Trial end date or countdown is displayed in the billing tab",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-ending-email",
      "category": "Transactional Emails",
      "description": "3-day reminder email sent before trial expires (when no payment method)",
      "steps": [
        "Set up org on trial without payment method",
        "Trigger customer.subscription.trial_will_end webhook (or wait for Stripe to fire it)",
        "Check email sent to org owner"
      ],
      "expected": "Email with subject about trial ending in 3 days, prompting to add payment method",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-ending-email-skipped-with-payment",
      "category": "Transactional Emails",
      "description": "3-day reminder NOT sent when org has payment method",
      "steps": [
        "Set up org on trial WITH payment method added",
        "Trigger customer.subscription.trial_will_end webhook",
        "Check whether email was sent"
      ],
      "expected": "No reminder email sent — org has payment method so Stripe handles trial→active normally",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-expiry-downgrade-to-free",
      "category": "Trial Expiry",
      "description": "Trial expiry without payment method downgrades to Free",
      "steps": [
        "Set up org on trial (e.g. Starter) without payment method",
        "Trigger trial expiry via subscription.updated webhook (status changes from trialing)",
        "Check org plan and status"
      ],
      "expected": "Org plan is Free, plan_status is 'active'. Stripe subscription cancelled.",
      "status": null,
      "feedback": null
    },
    {
      "id": "downgrade-converts-scheduled-to-adhoc",
      "category": "Trial Expiry",
      "description": "Downgrade to Free converts Scheduled discoveries to AdHoc",
      "steps": [
        "Set up org on paid plan with 3 Scheduled discoveries",
        "Downgrade to Free (via trial expiry or plan change)",
        "Check all discovery run types"
      ],
      "expected": "All previously Scheduled discoveries are now RunType::AdHoc. Not just disabled — actually converted.",
      "status": null,
      "feedback": null
    },
    {
      "id": "downgrade-sets-daemon-standby",
      "category": "Trial Expiry",
      "description": "Downgrade to Free puts DaemonPoll daemons on standby",
      "steps": [
        "Set up org on paid plan with 2 DaemonPoll daemons",
        "Downgrade to Free",
        "Check daemon standby field"
      ],
      "expected": "Both DaemonPoll daemons have standby=true. ServerPoll daemons (if any) are unaffected.",
      "status": null,
      "feedback": null
    },
    {
      "id": "downgrade-deletes-excess-hosts",
      "category": "Trial Expiry",
      "description": "Downgrade to Free deletes hosts exceeding 25, keeping most recent and daemon hosts",
      "steps": [
        "Set up org on paid plan with 40 hosts, one of which is a daemon's host",
        "Downgrade to Free",
        "Count remaining hosts",
        "Check which hosts were kept"
      ],
      "expected": "Exactly 25 hosts remain. Daemon host is preserved. Other 25 are the most recently updated. 15 hosts deleted.",
      "status": null,
      "feedback": null
    },
    {
      "id": "downgrade-email-with-overage",
      "category": "Transactional Emails",
      "description": "Trial expired/downgrade email includes overage counts",
      "steps": [
        "Set up org on paid plan with 40 hosts, 3 scheduled discoveries, 2 DaemonPoll daemons",
        "Trigger downgrade to Free (trial expiry without payment)",
        "Check the downgrade email"
      ],
      "expected": "Email mentions: 15 hosts deleted, 3 discoveries converted to manual, 2 daemons on standby. Prompts to upgrade.",
      "status": null,
      "feedback": null
    },
    {
      "id": "upgrade-clears-daemon-standby",
      "category": "Plan Changes",
      "description": "Upgrading from Free clears standby on DaemonPoll daemons",
      "steps": [
        "Have org on Free with DaemonPoll daemons on standby",
        "Upgrade to a paid plan with daemon_poll: true",
        "Check daemon standby field"
      ],
      "expected": "Daemon standby set to false after upgrade. Daemon can resume after restart.",
      "status": null,
      "feedback": null
    },
    {
      "id": "payment-method-collection",
      "category": "Payment Method",
      "description": "Setup payment method flow via Settings",
      "steps": [
        "Log in as org owner on Free or trialing plan without payment method",
        "Navigate to Settings > Billing tab",
        "Click 'Add Payment Method' CTA",
        "Verify redirect to Stripe Checkout in setup mode",
        "Complete payment method entry in Stripe",
        "Return to app"
      ],
      "expected": "Stripe Checkout opens in setup mode (no charge). After completion, has_payment_method is true. CTA disappears.",
      "status": null,
      "feedback": null
    },
    {
      "id": "notification-bubble-no-payment",
      "category": "Notification Bubble",
      "description": "Amber notification dot on Settings nav when no payment method on Free/trialing",
      "steps": [
        "Log in as user on Free plan without payment method",
        "Look at the sidebar navigation",
        "Check the Settings nav item"
      ],
      "expected": "Amber notification dot visible on Settings icon in sidebar",
      "status": null,
      "feedback": null
    },
    {
      "id": "notification-bubble-dismissed-after-payment",
      "category": "Notification Bubble",
      "description": "Notification dot disappears after payment method is added",
      "steps": [
        "Start with amber dot visible on Settings",
        "Add payment method via Settings > Billing",
        "Return to main app / refresh",
        "Check Settings nav item"
      ],
      "expected": "Amber notification dot is gone after has_payment_method becomes true",
      "status": null,
      "feedback": null
    },
    {
      "id": "plan-selection-modal-not-gating",
      "category": "Plan Selection",
      "description": "Plan selection is a modal, not a gating page — no 402 lockout",
      "steps": [
        "Log in as user on Free plan",
        "Navigate around the app (hosts, discovery, settings)",
        "Verify no 402 billing gating page appears",
        "Open plan selection via Settings > Billing > Change Plan",
        "Verify it opens as a modal overlay"
      ],
      "expected": "No gating redirect. Free plan users can navigate freely. Plan selection is a dismissible modal.",
      "status": null,
      "feedback": null
    },
    {
      "id": "change-plan-upgrade",
      "category": "Plan Changes",
      "description": "In-app upgrade from Free to paid plan",
      "steps": [
        "Log in as owner on Free plan",
        "Open plan selection modal",
        "Select a paid plan (e.g. Starter)",
        "Click upgrade button",
        "Complete checkout/trial flow"
      ],
      "expected": "Plan changes to selected plan. If trial available, trial starts without card. Otherwise checkout redirects to Stripe.",
      "status": null,
      "feedback": null
    },
    {
      "id": "change-plan-downgrade-preview",
      "category": "Plan Changes",
      "description": "Downgrade preview shows impact before confirming",
      "steps": [
        "Log in as owner on paid plan with hosts > 25, scheduled discoveries, DaemonPoll daemons",
        "Open plan selection modal",
        "Select Free plan / downgrade",
        "Before confirmation, check for preview information"
      ],
      "expected": "Confirmation dialog shows: X hosts to delete, Y discoveries to convert, Z daemons to standby. User must confirm.",
      "status": null,
      "feedback": null
    },
    {
      "id": "change-plan-downgrade-confirmed",
      "category": "Plan Changes",
      "description": "Confirmed downgrade executes all cleanup operations",
      "steps": [
        "From downgrade preview dialog, click Confirm",
        "Wait for operation to complete",
        "Check plan, hosts, discoveries, daemons"
      ],
      "expected": "Plan is Free. Excess hosts deleted. Scheduled→AdHoc. DaemonPoll→standby. Email sent.",
      "status": null,
      "feedback": null
    },
    {
      "id": "frontend-scheduled-discovery-disabled",
      "category": "Frontend Enforcement",
      "description": "Scheduled discovery option disabled with UpgradeBadge on Free plan",
      "steps": [
        "Log in on Free plan",
        "Open discovery creation modal",
        "Look at the run type options"
      ],
      "expected": "Scheduled option is disabled/greyed out. UpgradeBadge ('Upgrade') shown next to it. Only AdHoc selectable.",
      "status": null,
      "feedback": null
    },
    {
      "id": "frontend-daemon-poll-disabled",
      "category": "Frontend Enforcement",
      "description": "DaemonPoll option disabled with UpgradeBadge on Free plan",
      "steps": [
        "Log in on Free plan",
        "Open Create Daemon modal (or navigate to daemon creation)",
        "Look at daemon mode options"
      ],
      "expected": "DaemonPoll option is disabled. UpgradeBadge shown next to it. ServerPoll is default/only option.",
      "status": null,
      "feedback": null
    },
    {
      "id": "frontend-host-limit-indicator",
      "category": "Frontend Enforcement",
      "description": "Host count indicator and limit enforcement in UI",
      "steps": [
        "Log in on Free plan with 20 hosts",
        "Navigate to Hosts tab",
        "Check for host count indicator (e.g. '20 / 25 hosts')",
        "Add hosts until reaching 25",
        "Check indicator and create button state at 25/25"
      ],
      "expected": "Shows 'X / 25 hosts'. At 25/25: create button disabled, UpgradeBadge shown, 'Upgrade for unlimited hosts' messaging.",
      "status": null,
      "feedback": null
    },
    {
      "id": "frontend-host-limit-warning",
      "category": "Frontend Enforcement",
      "description": "Warning shown when approaching host limit",
      "steps": [
        "Log in on Free plan with 22 hosts",
        "Navigate to Hosts tab",
        "Check for warning indicator"
      ],
      "expected": "Warning styling visible when approaching limit (20+/25), indicating user is close to cap",
      "status": null,
      "feedback": null
    },
    {
      "id": "upgrade-badge-opens-settings",
      "category": "Frontend Enforcement",
      "description": "Clicking UpgradeBadge navigates to settings/billing",
      "steps": [
        "Log in on Free plan",
        "Find any UpgradeBadge (on disabled Scheduled, DaemonPoll, or host limit)",
        "Click the UpgradeBadge"
      ],
      "expected": "User is navigated to Settings page (billing tab) where they can change plan",
      "status": null,
      "feedback": null
    },
    {
      "id": "billing-tab-free-plan-info",
      "category": "Settings Billing Tab",
      "description": "Billing tab shows Free plan limits and upgrade prompt",
      "steps": [
        "Log in as owner on Free plan",
        "Navigate to Settings > Billing tab",
        "Review the displayed information"
      ],
      "expected": "Shows: current plan (Free), host usage with progress bar (X/25), 'Manual discovery only', 'ServerPoll only', prominent upgrade CTA",
      "status": null,
      "feedback": null
    },
    {
      "id": "billing-tab-trial-info",
      "category": "Settings Billing Tab",
      "description": "Billing tab shows trial countdown and payment CTA during trial",
      "steps": [
        "Log in as owner on trialing plan without payment method",
        "Navigate to Settings > Billing tab"
      ],
      "expected": "Shows trial countdown from trial_end_date, prominent 'Add Payment Method' CTA",
      "status": null,
      "feedback": null
    },
    {
      "id": "email-trial-started",
      "category": "Transactional Emails",
      "description": "Trial started email sent on trial activation",
      "steps": [
        "Start a trial on paid plan",
        "Check email inbox"
      ],
      "expected": "Email received: 'Welcome to your [Plan] trial! [X] days to explore.'",
      "status": null,
      "feedback": null
    },
    {
      "id": "email-payment-method-added",
      "category": "Transactional Emails",
      "description": "Confirmation email sent when payment method is added",
      "steps": [
        "Add payment method via Settings > Billing",
        "Check email inbox"
      ],
      "expected": "Email received confirming payment method added and subscription will continue after trial",
      "status": null,
      "feedback": null
    },
    {
      "id": "email-plan-changed",
      "category": "Transactional Emails",
      "description": "Email sent on plan change (upgrade or downgrade)",
      "steps": [
        "Change plan via plan selection modal (upgrade or downgrade)",
        "Check email inbox"
      ],
      "expected": "Email received describing the plan change and what changed",
      "status": null,
      "feedback": null
    },
    {
      "id": "paid-plan-no-restrictions",
      "category": "Paid Plans",
      "description": "Paid plans have no Free tier restrictions",
      "steps": [
        "Log in as owner on Starter or higher plan",
        "Verify: no host limit indicator, Scheduled discovery enabled, DaemonPoll enabled",
        "Create hosts freely past 25",
        "Create Scheduled discovery",
        "Register DaemonPoll daemon"
      ],
      "expected": "No restrictions. All features available. No UpgradeBadges visible. No host limit.",
=======
      "id": "brevo-cookie-consent-with-brevo",
      "category": "Frontend Cleanup",
      "description": "Cookie consent banner behavior with Brevo configured",
      "steps": [
        "Set SCANOPY_BREVO_API_KEY",
        "Load the app as a new user (clear cookies first)",
        "Check if cookie consent banner appears"
      ],
      "expected": "Cookie consent banner appears when Brevo is configured (needs_cookie_consent returns true).",
>>>>>>> brevo-integration
=======
      "id": "metadata-api-includes-raw-socket-flag",
      "category": "API",
      "description": "The /api/metadata endpoint returns has_raw_socket_endpoint for service definitions",
      "steps": [
        "Call GET /api/metadata",
        "Inspect the service_definitions array",
        "Find Prometheus Node Exporter and JetDirect entries"
      ],
      "expected": "Prometheus Node Exporter has has_raw_socket_endpoint: true. JetDirect has has_raw_socket_endpoint: false (it uses Pattern::Port, not Pattern::Endpoint). Other services on non-raw-socket ports have has_raw_socket_endpoint: false.",
>>>>>>> fix-ghost-printing
=======
=======
      "setup": "Org on the Free plan (default state after setup flow).",
>>>>>>> billing-overhaul
      "expected": "User returns to / with billing modal still showing",
>>>>>>> billing-overhaul
      "status": null,
      "feedback": null
    }
  ]
}
