{
  "branch": "billing-overhaul",
  "tests": [
    {
      "id": "billing-modal-opens-no-plan",
      "category": "Billing Modal",
      "description": "New user sees non-dismissible billing modal after onboarding",
      "steps": [
        "After onboarding completes, verify the billing plan modal opens automatically",
        "Verify the modal has title 'Choose a Plan' and is full-screen",
        "Verify clicking outside does NOT close the modal",
        "Verify no close (X) button is shown"
      ],
      "expected": "Full-screen billing modal opens with plan options, cannot be dismissed",
      "flow": "setup",
      "sequence": 1,
      "status": null,
      "feedback": null
    },
    {
      "id": "billing-modal-plan-toggles",
      "category": "Billing Modal",
      "description": "Monthly/yearly and personal/commercial toggles work",
      "steps": [
        "Click the Monthly/Yearly toggle",
        "Verify prices update to reflect the selected billing period",
        "Click the Personal/Commercial toggle",
        "Verify plan cards filter to show the correct category"
      ],
      "expected": "Toggles are responsive and filter/update plan display correctly",
      "flow": "setup",
      "sequence": 2,
      "status": null,
      "feedback": null
    },
    {
      "id": "free-plan-checkout",
      "category": "Billing Modal",
      "description": "Selecting Free plan completes $0 Stripe checkout without requiring a card",
      "steps": [
        "Select the Free plan",
        "Verify redirect to Stripe checkout",
        "Complete the $0 checkout — no credit card should be required",
        "Verify redirect back to the app",
        "Verify the billing modal is gone and the app is accessible"
      ],
      "expected": "Stripe checkout completes without payment method, user returns to app with Free plan active, modal dismissed",
      "flow": "setup",
      "sequence": 3,
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-offers-first-time",
      "category": "Billing Modal",
      "description": "Trial badges shown for orgs that have never trialed a paid plan",
      "steps": [
        "Open Settings > Billing tab",
        "Click 'View Plans'",
        "Verify paid plans show trial day badges (e.g., '7-day free trial')"
      ],
      "setup": "Org should be on the Free plan with no trial_end_date set (the default state after the setup flow).",
      "expected": "Trial offers visible on paid plans",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-offers-returning",
      "category": "Billing Modal",
      "description": "Trial badges hidden for orgs that have previously trialed",
      "steps": [
        "Open Settings > Billing tab",
        "Click 'View Plans'",
        "Verify paid plans do NOT show trial day badges"
      ],
      "setup": "Set trial_end_date on the org to a past date: UPDATE organizations SET trial_end_date = NOW() - INTERVAL '1 day' WHERE id = '<org_id>'. Refresh the browser before testing.",
      "expected": "No trial offers shown to returning customers",
      "status": null,
      "feedback": null
    },
    {
      "id": "settings-billing-free-plan-cta",
      "category": "Settings",
      "description": "Free plan users see upgrade CTA and no subscription management in Billing tab",
      "steps": [
        "Open Settings > Billing tab",
        "Verify an 'Upgrade your plan' card with 'View Plans' button is shown",
        "Verify 'Manage Subscription' button is NOT present"
      ],
      "setup": "Org should be on the Free plan (default state after setup flow).",
      "expected": "Prominent upgrade CTA shown, no subscription management for Free plan",
      "status": null,
      "feedback": null
    },
    {
      "id": "settings-billing-notification-dot",
      "category": "Settings",
      "description": "Billing tab shows notification dot when trialing without payment method",
      "steps": [
        "Open the Settings modal",
        "Verify the Billing tab label has a notification dot"
      ],
      "setup": "Set org to trialing status without a payment method: UPDATE organizations SET plan_status = 'trialing', has_payment_method = false WHERE id = '<org_id>'. Refresh the browser before testing.",
      "expected": "Notification dot visible on Billing tab",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-mode-richselect-upgrade",
      "category": "Daemon Creation",
      "description": "Daemon mode dropdown shows Upgrade tag on DaemonPoll for Free plan",
      "steps": [
        "Navigate to the Daemons page and open the daemon creation modal",
        "Open the Mode dropdown — it should be a rich dropdown, not a native select",
        "Verify ServerPoll is selectable",
        "Verify DaemonPoll shows a yellow 'Upgrade' tag with an arrow icon",
        "Verify DaemonPoll is not selectable (disabled/grayed out)"
      ],
      "setup": "Org should be on the Free plan. Ensure at least one network exists (POST /api/networks with a name).",
      "expected": "RichSelect dropdown with yellow Upgrade tag on DaemonPoll, option disabled",
      "status": null,
      "feedback": null
    },
    {
      "id": "discovery-run-type-richselect-upgrade",
      "category": "Discovery",
      "description": "Discovery run type dropdown shows Upgrade tag on Scheduled for Free plan",
      "steps": [
        "Navigate to the Discoveries page and open the discovery creation modal",
        "Open the Run Type dropdown — it should be a rich dropdown, not a native select",
        "Verify Ad Hoc is selectable",
        "Verify Scheduled shows a yellow 'Upgrade' tag with an arrow icon",
        "Verify Scheduled is not selectable (disabled)"
      ],
      "setup": "Org should be on the Free plan. Ensure at least one daemon exists (create via the Daemons page or API).",
      "expected": "RichSelect dropdown with yellow Upgrade tag on Scheduled, option disabled",
      "status": null,
      "feedback": null
    },
    {
      "id": "paid-plan-no-upgrade-tags",
      "category": "Paid Plan",
      "description": "Paid plan users see no upgrade tags in daemon/discovery dropdowns",
      "steps": [
        "Open daemon creation modal, open the Mode dropdown",
        "Verify DaemonPoll has no Upgrade tag and is selectable",
        "Open discovery creation modal, open the Run Type dropdown",
        "Verify Scheduled has no Upgrade tag and is selectable"
      ],
      "setup": "Org should be on a paid plan (e.g., Starter). Set via Stripe checkout or DB: UPDATE organizations SET plan = 'Starter', plan_status = 'active' WHERE id = '<org_id>'. Ensure at least one network and one daemon exist.",
      "expected": "No upgrade tags, all options selectable for paid plans",
      "status": null,
      "feedback": null
    },
    {
      "id": "stripe-cancel-returns-home",
      "category": "Billing",
      "description": "Canceling Stripe checkout returns to app root, not /billing",
      "steps": [
        "Open Settings > Billing > View Plans",
        "Select any paid plan to start checkout",
        "On the Stripe checkout page, click Back or cancel",
        "Verify the return URL is the app root (/), not /billing"
      ],
      "setup": "Org on the Free plan (default state after setup flow).",
      "expected": "User returns to / with billing modal still showing",
      "status": null,
      "feedback": null
    }
  ]
}
